name: Rust Build and Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'rust-v*'
      - 'v*-rust'
    paths:
      - 'rust/**'
      - '.github/workflows/rust-build.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'rust/**'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build-windows:
    name: Build Windows AMD64
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: x86_64-pc-windows-msvc

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-registry-

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-git-

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: rust/target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-build-target-

    - name: Check Rust version
      run: |
        rustc --version
        cargo --version

    - name: Build release binary
      working-directory: ./rust
      run: |
        cargo build --release --target x86_64-pc-windows-msvc
        echo "Build completed successfully"

    - name: Get version info
      id: version
      shell: bash
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION="${{ github.ref_name }}"
        else
          VERSION="dev-$(git rev-parse --short HEAD)"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: Prepare release files
      shell: bash
      run: |
        mkdir -p release
        cp rust/target/x86_64-pc-windows-msvc/release/aiclient2api-rust.exe release/
        cp rust/config.example.json release/config.json
        cp rust/provider_pools.example.json release/provider_pools.json
        cp rust/README.md release/
        cp rust/QUICKSTART.md release/
        cp LICENSE release/ 2>/dev/null || echo "No LICENSE file"

        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        cat > release/start.bat << 'EOF'
        @echo off
        chcp 65001 >nul
        echo ========================================
        echo AIClient-2-API Rust Server
        echo ========================================
        echo.

        if not exist config.json (
            echo [é”™è¯¯] æœªæ‰¾åˆ° config.json é…ç½®æ–‡ä»¶ï¼
            echo.
            echo è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š
            echo 1. å°† config.json å¤åˆ¶ä¸€ä»½å¹¶é‡å‘½å
            echo 2. ç¼–è¾‘ config.json å¡«å…¥ä½ çš„é…ç½®
            echo 3. å†æ¬¡è¿è¡Œæ­¤è„šæœ¬
            echo.
            pause
            exit /b 1
        )

        echo [ä¿¡æ¯] ä½¿ç”¨ config.json å¯åŠ¨æœåŠ¡å™¨...
        echo [ä¿¡æ¯] æŒ‰ Ctrl+C åœæ­¢æœåŠ¡å™¨
        echo.
        aiclient2api-rust.exe --config config.json
        echo.
        echo [ä¿¡æ¯] æœåŠ¡å™¨å·²åœæ­¢
        pause
        EOF

        # åˆ›å»ºè°ƒè¯•å¯åŠ¨è„šæœ¬
        cat > release/start-debug.bat << 'EOF'
        @echo off
        chcp 65001 >nul
        echo ========================================
        echo AIClient-2-API Rust Server (è°ƒè¯•æ¨¡å¼)
        echo ========================================
        echo.

        if not exist config.json (
            echo [é”™è¯¯] æœªæ‰¾åˆ° config.json é…ç½®æ–‡ä»¶ï¼
            echo.
            pause
            exit /b 1
        )

        echo [ä¿¡æ¯] è°ƒè¯•æ¨¡å¼å¯åŠ¨ä¸­...
        echo [ä¿¡æ¯] å°†æ˜¾ç¤ºè¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
        echo [ä¿¡æ¯] æŒ‰ Ctrl+C åœæ­¢æœåŠ¡å™¨
        echo.
        set RUST_LOG=debug
        aiclient2api-rust.exe --config config.json
        echo.
        echo [ä¿¡æ¯] æœåŠ¡å™¨å·²åœæ­¢
        pause
        EOF

        # åˆ›å»ºå‘½ä»¤è¡Œå‚æ•°å¯åŠ¨ç¤ºä¾‹
        cat > release/start-with-args.bat << 'EOF'
        @echo off
        chcp 65001 >nul
        echo ========================================
        echo AIClient-2-API Rust Server
        echo å‘½ä»¤è¡Œå‚æ•°å¯åŠ¨ç¤ºä¾‹
        echo ========================================
        echo.
        echo æ­¤è„šæœ¬æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°å¯åŠ¨æœåŠ¡å™¨
        echo è€Œä¸æ˜¯ä½¿ç”¨ config.json æ–‡ä»¶
        echo.
        echo ä½ å¯ä»¥ä¿®æ”¹ä¸‹é¢çš„å‚æ•°ï¼š
        echo.

        REM é…ç½®å‚æ•°ï¼ˆæ ¹æ®éœ€è¦ä¿®æ”¹ï¼‰
        set HOST=localhost
        set PORT=3000
        set API_KEY=your-secret-key-here
        set MODEL_PROVIDER=claude-kiro-oauth

        echo [ä¿¡æ¯] ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°å¯åŠ¨æœåŠ¡å™¨...
        echo [ä¿¡æ¯] ä¸»æœº: %HOST%
        echo [ä¿¡æ¯] ç«¯å£: %PORT%
        echo [ä¿¡æ¯] æä¾›å•†: %MODEL_PROVIDER%
        echo.

        aiclient2api-rust.exe ^
          --host %HOST% ^
          --port %PORT% ^
          --api-key %API_KEY% ^
          --model-provider %MODEL_PROVIDER%

        echo.
        echo [ä¿¡æ¯] æœåŠ¡å™¨å·²åœæ­¢
        pause
        EOF

        # åˆ›å»º Kiro ä¸“ç”¨å¯åŠ¨è„šæœ¬
        cat > release/start-kiro.bat << 'EOF'
        @echo off
        chcp 65001 >nul
        echo ========================================
        echo AIClient-2-API Rust Server
        echo Kiro æä¾›å•† (Claude Sonnet 4)
        echo ========================================
        echo.

        set KIRO_CREDS=%USERPROFILE%\.aws\sso\cache\kiro-auth-token.json

        if not exist "%KIRO_CREDS%" (
            echo [é”™è¯¯] æœªæ‰¾åˆ° Kiro å‡­æ®æ–‡ä»¶ï¼
            echo.
            echo é¢„æœŸä½ç½®: %KIRO_CREDS%
            echo.
            echo è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š
            echo 1. ä» https://aibook.ren/archives/kiro-install å®‰è£… Kiro å®¢æˆ·ç«¯
            echo 2. å®Œæˆ OAuth ç™»å½•ç”Ÿæˆå‡­æ®
            echo 3. å†æ¬¡è¿è¡Œæ­¤è„šæœ¬
            echo.
            pause
            exit /b 1
        )

        echo [ä¿¡æ¯] æ‰¾åˆ° Kiro å‡­æ®: %KIRO_CREDS%
        echo [ä¿¡æ¯] ä½¿ç”¨ Kiro æä¾›å•†å¯åŠ¨æœåŠ¡å™¨...
        echo [ä¿¡æ¯] æŒ‰ Ctrl+C åœæ­¢æœåŠ¡å™¨
        echo.

        aiclient2api-rust.exe ^
          --host localhost ^
          --port 3000 ^
          --api-key your-secret-key-here ^
          --model-provider claude-kiro-oauth ^
          --kiro-oauth-creds-file "%KIRO_CREDS%"

        echo.
        echo [ä¿¡æ¯] æœåŠ¡å™¨å·²åœæ­¢
        pause
        EOF

        # åˆ›å»ºå¸®åŠ©è„šæœ¬
        cat > release/help.bat << 'EOF'
        @echo off
        chcp 65001 >nul
        cls
        echo ========================================
        echo AIClient-2-API Rust Server - å¸®åŠ©
        echo ========================================
        echo.
        echo å¯ç”¨çš„å¯åŠ¨è„šæœ¬ï¼š
        echo.
        echo   start.bat              - ä½¿ç”¨ config.json å¯åŠ¨ï¼ˆæ¨èï¼‰
        echo   start-debug.bat        - è°ƒè¯•æ¨¡å¼å¯åŠ¨
        echo   start-with-args.bat    - ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°å¯åŠ¨
        echo   start-kiro.bat         - ä½¿ç”¨ Kiro æä¾›å•†å¯åŠ¨
        echo   help.bat               - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯
        echo.
        echo ========================================
        echo å‘½ä»¤è¡Œå‚æ•°
        echo ========================================
        echo.
        echo æœåŠ¡å™¨é…ç½®ï¼š
        echo   --host ^<åœ°å€^>          æœåŠ¡å™¨åœ°å€ï¼ˆé»˜è®¤ï¼šlocalhostï¼‰
        echo   --port ^<ç«¯å£^>          æœåŠ¡å™¨ç«¯å£ï¼ˆé»˜è®¤ï¼š3000ï¼‰
        echo   --api-key ^<å¯†é’¥^>       API å¯†é’¥
        echo   --config ^<è·¯å¾„^>        é…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆé»˜è®¤ï¼šconfig.jsonï¼‰
        echo.
        echo æä¾›å•†é…ç½®ï¼š
        echo   --model-provider ^<æä¾›å•†^>
        echo       å¯ç”¨æä¾›å•†ï¼š
        echo       - gemini-cli-oauth      (Gemini OAuth)
        echo       - openai-custom         (OpenAI å…¼å®¹)
        echo       - claude-custom         (Claude å…¼å®¹)
        echo       - claude-kiro-oauth     (Kiro Claude - å…è´¹ Sonnet 4)
        echo       - openai-qwen-oauth     (Qwen Code Plus)
        echo.
        echo OpenAI é…ç½®ï¼š
        echo   --openai-api-key ^<å¯†é’¥^>
        echo   --openai-base-url ^<URL^>
        echo.
        echo Claude é…ç½®ï¼š
        echo   --claude-api-key ^<å¯†é’¥^>
        echo   --claude-base-url ^<URL^>
        echo.
        echo Kiro é…ç½®ï¼š
        echo   --kiro-oauth-creds-file ^<è·¯å¾„^>
        echo   --kiro-oauth-creds-base64 ^<base64^>
        echo.
        echo Gemini é…ç½®ï¼š
        echo   --gemini-oauth-creds-file ^<è·¯å¾„^>
        echo   --project-id ^<é¡¹ç›®ID^>
        echo.
        echo Qwen é…ç½®ï¼š
        echo   --qwen-oauth-creds-file ^<è·¯å¾„^>
        echo.
        echo æ—¥å¿—é…ç½®ï¼š
        echo   --log-prompts ^<æ¨¡å¼^>    æ—¥å¿—æ¨¡å¼ï¼šconsole, file, none
        echo.
        echo ========================================
        echo ä½¿ç”¨ç¤ºä¾‹
        echo ========================================
        echo.
        echo 1. ä½¿ç”¨é…ç½®æ–‡ä»¶å¯åŠ¨ï¼š
        echo    aiclient2api-rust.exe --config config.json
        echo.
        echo 2. ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°å¯åŠ¨ï¼š
        echo    aiclient2api-rust.exe --host 0.0.0.0 --port 8080 --api-key secret
        echo.
        echo 3. ä½¿ç”¨ Kiro æä¾›å•†å¯åŠ¨ï¼š
        echo    aiclient2api-rust.exe --model-provider claude-kiro-oauth ^
        echo      --kiro-oauth-creds-file %%USERPROFILE%%\.aws\sso\cache\kiro-auth-token.json
        echo.
        echo 4. å¯ç”¨è°ƒè¯•æ—¥å¿—ï¼š
        echo    set RUST_LOG=debug
        echo    aiclient2api-rust.exe --config config.json
        echo.
        echo ========================================
        echo æ–‡æ¡£
        echo ========================================
        echo.
        echo æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ï¼š
        echo   - README.md
        echo   - QUICKSTART.md
        echo   - https://github.com/justlovemaki/AIClient-2-API
        echo.
        pause
        EOF

        # åˆ›å»º README
        cat > release/README.txt << 'EOF'
        AIClient-2-API Rust ç‰ˆæœ¬ - Windows AMD64
        ============================================

        å¿«é€Ÿå¼€å§‹ï¼š
        1. å¤åˆ¶ config.json æ–‡ä»¶
        2. ç¼–è¾‘ config.json å¡«å…¥ä½ çš„é…ç½®
        3. åŒå‡» start.bat è¿è¡ŒæœåŠ¡å™¨

        è°ƒè¯•æ¨¡å¼ï¼š
        - åŒå‡» start-debug.bat

        æ›´å¤šä¿¡æ¯ï¼š
        - æŸ¥çœ‹ README.md äº†è§£è¯¦ç»†æ–‡æ¡£
        - æŸ¥çœ‹ QUICKSTART.md å¿«é€Ÿå¼€å§‹æŒ‡å—
        - è¿è¡Œ help.bat æŸ¥çœ‹å‘½ä»¤è¡Œå‚æ•°å¸®åŠ©

        é…ç½®æ–‡ä»¶ï¼š
        - config.json: ä¸»é…ç½®æ–‡ä»¶
        - provider_pools.json: å¤šè´¦å·æ± é…ç½®ï¼ˆå¯é€‰ï¼‰

        é»˜è®¤è®¾ç½®ï¼š
        - ä¸»æœº: localhost
        - ç«¯å£: 3000
        - API å¯†é’¥: åœ¨ config.json ä¸­è®¾ç½®

        æ”¯æŒçš„æä¾›å•†ï¼š
        - gemini-cli-oauth: Gemini OAuth æ–¹å¼
        - openai-custom: OpenAI å…¼å®¹ API
        - claude-custom: Claude å…¼å®¹ API
        - claude-kiro-oauth: Kiro Claude (å…è´¹ Sonnet 4)
        - openai-qwen-oauth: Qwen Code Plus

        æ€§èƒ½ä¼˜åŠ¿ï¼š
        - å¯åŠ¨é€Ÿåº¦: æ¯” Node.js å¿« 4 å€
        - å†…å­˜å ç”¨: å‡å°‘ 75%
        - è¯·æ±‚å»¶è¿Ÿ: é™ä½ 40%
        - ååé‡: æå‡ 3 å€

        æ–‡æ¡£ï¼š
        https://github.com/justlovemaki/AIClient-2-API

        ============================================
        EOF

        ls -lh release/

    - name: Create ZIP archive
      shell: bash
      run: |
        cd release
        7z a -tzip ../aiclient2api-rust-windows-amd64-${{ steps.version.outputs.version }}.zip *
        cd ..
        ls -lh *.zip

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: aiclient2api-rust-windows-amd64-${{ steps.version.outputs.version }}
        path: aiclient2api-rust-windows-amd64-${{ steps.version.outputs.version }}.zip
        retention-days: 30

    - name: Calculate checksums
      if: startsWith(github.ref, 'refs/tags/')
      shell: bash
      run: |
        sha256sum aiclient2api-rust-windows-amd64-${{ steps.version.outputs.version }}.zip > checksums.txt
        cat checksums.txt

    - name: Upload checksums
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/upload-artifact@v4
      with:
        name: checksums
        path: checksums.txt
        retention-days: 30

  test-windows:
    name: Test on Windows
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable

    - name: Cache cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          rust/target
        key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-test-

    - name: Run tests
      working-directory: ./rust
      run: |
        cargo test --release -- --nocapture

    - name: Run clippy
      working-directory: ./rust
      run: |
        cargo clippy -- -D warnings

    - name: Check formatting
      working-directory: ./rust
      run: |
        cargo fmt -- --check

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-windows, test-windows]
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: Display structure of downloaded files
      run: |
        ls -R ./artifacts

    - name: Prepare release notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        ## AIClient-2-API Rust Version - Windows AMD64 Release

        ### ğŸ¦€ Rust ç‰ˆæœ¬ç‰¹æ€§

        - âš¡ **é«˜æ€§èƒ½**: æ¯” Node.js ç‰ˆæœ¬å¿« 3-4 å€
        - ğŸ’¾ **ä½å†…å­˜**: å†…å­˜å ç”¨å‡å°‘ 75%
        - ğŸš€ **é«˜åå**: ååé‡æå‡ 3 å€
        - ğŸ“¦ **å•ä¸€äºŒè¿›åˆ¶**: æ— éœ€å®‰è£…ä¾èµ–ï¼Œå¼€ç®±å³ç”¨

        ### ğŸ“¦ åŒ…å«å†…å®¹

        - `aiclient2api-rust.exe` - ä¸»ç¨‹åº
        - `config.json` - é…ç½®æ–‡ä»¶ç¤ºä¾‹
        - `provider_pools.json` - è´¦å·æ± é…ç½®ç¤ºä¾‹
        - `start.bat` - å¿«é€Ÿå¯åŠ¨è„šæœ¬ï¼ˆæ¨èï¼‰
        - `start-debug.bat` - è°ƒè¯•æ¨¡å¼å¯åŠ¨è„šæœ¬
        - `start-with-args.bat` - å‘½ä»¤è¡Œå‚æ•°å¯åŠ¨ç¤ºä¾‹
        - `start-kiro.bat` - Kiro ä¸“ç”¨å¯åŠ¨è„šæœ¬
        - `help.bat` - å‘½ä»¤è¡Œå‚æ•°å¸®åŠ©
        - `README.md` - è¯¦ç»†æ–‡æ¡£
        - `QUICKSTART.md` - å¿«é€Ÿå¼€å§‹æŒ‡å—
        - `README.txt` - Windows å¿«é€ŸæŒ‡å—

        ### ğŸš€ å¿«é€Ÿå¼€å§‹

        **æ–¹æ³• 1ï¼šä½¿ç”¨é…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰**
        1. ä¸‹è½½å¹¶è§£å‹ ZIP æ–‡ä»¶
        2. ç¼–è¾‘ `config.json` é…ç½®æ–‡ä»¶
        3. åŒå‡» `start.bat` å¯åŠ¨æœåŠ¡å™¨

        **æ–¹æ³• 2ï¼šä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°**
        1. ç¼–è¾‘ `start-with-args.bat` ä¿®æ”¹å‚æ•°
        2. åŒå‡»è¿è¡Œ

        **æ–¹æ³• 3ï¼šä½¿ç”¨ Kiroï¼ˆå…è´¹ Claude Sonnet 4ï¼‰**
        1. å®‰è£… Kiro å®¢æˆ·ç«¯å¹¶å®Œæˆç™»å½•
        2. åŒå‡» `start-kiro.bat` å¯åŠ¨

        ### ğŸ“ é…ç½®è¯´æ˜

        ```json
        {
          "host": "localhost",
          "port": 3000,
          "required_api_key": "your-secret-key",
          "model_provider": "claude-kiro-oauth"
        }
        ```

        ### ğŸ”§ æ”¯æŒçš„æä¾›å•†

        - `gemini-cli-oauth` - Gemini OAuth æ–¹å¼
        - `openai-custom` - OpenAI å…¼å®¹ API
        - `claude-custom` - Claude å…¼å®¹ API
        - `claude-kiro-oauth` - Kiro Claude (å…è´¹ Sonnet 4)
        - `openai-qwen-oauth` - Qwen Code Plus

        ### ğŸ“Š æ€§èƒ½å¯¹æ¯”

        | æŒ‡æ ‡ | Node.js | Rust | æå‡ |
        |------|---------|------|------|
        | å¯åŠ¨é€Ÿåº¦ | 200ms | 50ms | 4x |
        | å†…å­˜å ç”¨ | 80MB | 20MB | 4x |
        | è¯·æ±‚å»¶è¿Ÿ | 100ms | 60ms | 40% |
        | ååé‡ | 5k/s | 15k/s | 3x |

        ### ğŸ› å·²çŸ¥é—®é¢˜

        æ— 

        ### ğŸ“– æ–‡æ¡£

        - [å®Œæ•´æ–‡æ¡£](https://github.com/justlovemaki/AIClient-2-API)
        - [Rust ç‰ˆæœ¬è¯´æ˜](https://github.com/justlovemaki/AIClient-2-API/tree/main/rust)

        ### ğŸ” æ ¡éªŒå’Œ

        è¯·æŸ¥çœ‹ `checksums.txt` æ–‡ä»¶éªŒè¯ä¸‹è½½å®Œæ•´æ€§ã€‚
        EOF

        cat release_notes.md

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/aiclient2api-rust-windows-amd64-*/aiclient2api-rust-windows-amd64-*.zip
          artifacts/checksums/checksums.txt
        body_path: release_notes.md
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # å¯é€‰ï¼šæ„å»ºå…¶ä»–å¹³å°
  build-other-platforms:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')

    strategy:
      matrix:
        include:
          - platform: linux-amd64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            binary: aiclient2api-rust
            archive: tar.gz

          - platform: linux-arm64
            os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            binary: aiclient2api-rust
            archive: tar.gz

          - platform: macos-amd64
            os: macos-latest
            target: x86_64-apple-darwin
            binary: aiclient2api-rust
            archive: tar.gz

          - platform: macos-arm64
            os: macos-latest
            target: aarch64-apple-darwin
            binary: aiclient2api-rust
            archive: tar.gz

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: ${{ matrix.target }}

    - name: Install cross-compilation tools (Linux ARM64)
      if: matrix.target == 'aarch64-unknown-linux-gnu'
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu

    - name: Cache cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          rust/target
        key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.target }}-cargo-

    - name: Build release binary
      working-directory: ./rust
      run: |
        cargo build --release --target ${{ matrix.target }}

    - name: Get version info
      id: version
      shell: bash
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION="${{ github.ref_name }}"
        else
          VERSION="dev-$(git rev-parse --short HEAD)"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Prepare release files
      shell: bash
      run: |
        mkdir -p release
        cp rust/target/${{ matrix.target }}/release/${{ matrix.binary }} release/
        cp rust/config.example.json release/config.json
        cp rust/provider_pools.example.json release/provider_pools.json
        cp rust/README.md release/
        cp rust/QUICKSTART.md release/
        cp LICENSE release/ 2>/dev/null || true

    - name: Create archive
      shell: bash
      run: |
        cd release
        if [[ "${{ matrix.archive }}" == "tar.gz" ]]; then
          tar czf ../aiclient2api-rust-${{ matrix.platform }}-${{ steps.version.outputs.version }}.tar.gz *
        else
          zip -r ../aiclient2api-rust-${{ matrix.platform }}-${{ steps.version.outputs.version }}.zip *
        fi
        cd ..

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: aiclient2api-rust-${{ matrix.platform }}-${{ steps.version.outputs.version }}
        path: aiclient2api-rust-${{ matrix.platform }}-${{ steps.version.outputs.version }}.*
        retention-days: 30
